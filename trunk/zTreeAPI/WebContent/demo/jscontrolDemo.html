<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<HTML>
 <HEAD>
  <TITLE> ZTREE DEMO </TITLE>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" href="demoStyle/demo.css" type="text/css">
  <link rel="stylesheet" href="zTreeStyle/zTreeStyle.css" type="text/css">
  <script type="text/javascript" src="jquery-1.4.2.js"></script>
  <script type="text/javascript" src="jquery.ztree-2.6.js"></script>
  <script type="text/javascript" src="asyncData/demoData.js"></script>
  <script type="text/javascript" src="demoTools.js"></script>
  <SCRIPT LANGUAGE="JavaScript">
  <!--
	var zTree1;
	var setting;

	setting = {
		checkable : true,
		expandSpeed : false,
		callback: {
			beforeClick: zTreeBeforeClick,
			click:	zTreeOnClick,
			change: zTreeOnChange
		}
	};

	$(document).ready(function(){
		reloadTree();
		initCopyEvent();
	});

	function initSrcNode() {
		$("#renameTxt").attr("value", "");
		$("#curNodePath").html(getNodePath(null));
		showCopy(null);
		showPaste(null);
	}
	
	function zTreeOnClick(event, treeId, treeNode) {
		$("#curNodePath").html(getNodePath(treeNode));
		$("#renameTxt").attr("value", treeNode.name);
		showCopy(treeNode);
		showPaste(treeNode);
	}
	function zTreeBeforeClick(treeId, treeNode) {
		var canClick = (treeNode!=zTree1.getSelectedNode());
		if (!canClick) {
			zTree1.cancelSelectedNode();
			initSrcNode();
		}
		return canClick;
	}
	
	function zTreeOnChange(event, treeId, treeNode) {
		getNodes();
	}
	
	function expandAll(expandSign) {
		zTree1.expandAll(expandSign);
	}

	function expandNode(expandSign) {
		var srcNode = zTree1.getSelectedNode();
		if (srcNode) {
			zTree1.expandNode(srcNode, expandSign, $("#sonChk").attr("checked"));
		}
	}

	var addCount = 1;
	function addNode(type) {
		setOperatePool();
		var srcNode = zTree1.getSelectedNode();
		var newNode = [{ name:"澧炲姞" + (addCount++)}];
		if (type=="p") newNode[0].isParent = true;
		zTree1.addNodes(srcNode, newNode);
		getNodes();
	}
	function removeTreeNode() {
		var srcNode = zTree1.getSelectedNode();
		if (srcNode) {
			if (srcNode.nodes && srcNode.nodes.length > 0) {
				var msg = "瑕佸垹闄ょ殑鑺傜偣鏄埗鑺傜偣锛屽鏋滃垹闄ゅ皢杩炲悓瀛愯妭鐐逛竴璧峰垹鎺夈�\n\n璇风‘璁わ紒";
				if (confirm(msg)==true){
					setOperatePool();
					zTree1.removeNode(srcNode);
					initSrcNode();
				}
			} else {
				setOperatePool();
				zTree1.removeNode(srcNode);
				initSrcNode();
			}
		}	
		getNodes();
	}

	function getPreTreeNode(treeNode) {
		if (treeNode.isFirstNode) return null;
		var nodes = treeNode.parentNode ? treeNode.parentNode.nodes : zTree1.getNodes();
		var preNode;
		for (var i=0; i<nodes.length; i++) {
			if (nodes[i] == treeNode) {
				return preNode;
			}
			preNode = nodes[i];
		}
	}
	function getNextTreeNode(treeNode) {
		if (treeNode.isLastNode) return null;
		var nodes = treeNode.parentNode ? treeNode.parentNode.nodes : zTree1.getNodes();
		for (var i=0; i<nodes.length; i++) {
			if (nodes[i] == treeNode) {
				return nodes[i+1];
			}
		}
	}
	
	function moveTreeNode(move) {
		var srcNode = zTree1.getSelectedNode();
		if (!srcNode) {
			alert("璇峰厛閫変腑涓�釜鑺傜偣");
			return;
		}
		var moveType = "inner";
		var targetNode = "";
		if (move == "up") {
			moveType = "before";
			targetNode = getPreTreeNode(srcNode);
		} else if (move == "down") {
			moveType = "after";
			targetNode = getNextTreeNode(srcNode);
		} else if (move == "left") {
			moveType = "after";
			targetNode = srcNode.parentNode;
		} else if (move == "right") {
			moveType = "inner";
			targetNode = getPreTreeNode(srcNode);
		}
		if (srcNode && targetNode) {
			setOperatePool();
			zTree1.moveNode(targetNode, srcNode, moveType);
		}	
		getNodes();
		zTree1.selectNode(srcNode);
	}

	function getNodes() {
		var a = zTree1.transformToArray(zTree1.getNodes());
		$("#allNum").html(a.length);
		a = zTree1.getCheckedNodes();
		$("#allCheckNum").html(a.length);
		
	}

	function makeListName(node) {
		var space = "";
		for (var s = 0; s<node.level; s++ ) {
			space = space + "--";
		}
		return space + node.name + "(" + node.tId + ")";
	}

	function renameTreeNode(txtObj) {
		var srcNode = zTree1.getSelectedNode();
		if (!srcNode) {
			alert("璇峰厛閫変腑涓�釜鑺傜偣");
			$("#renameTxt").attr("value", "");
			return;
		}
		if (srcNode.name != txtObj.value) {
			setOperatePool();
			srcNode.name = txtObj.value;
			zTree1.updateNode(srcNode);
			zTree1.selectNode(srcNode);
		}
		
	}
	function checkTreeNode(checked) {
		var srcNode = zTree1.getSelectedNode();
		if (!srcNode) {
			alert("璇峰厛閫変腑涓�釜鑺傜偣");
			return;
		}
		var oldNodes = clone(zTree1.getNodes());
		var oldcheckNum = zTree1.getCheckedNodes(checked).length;
		var connFlag = $("#connTrue").attr("checked");
		srcNode.checked = checked;
		zTree1.updateNode(srcNode, connFlag);
		var newcheckNum = zTree1.getCheckedNodes(checked).length;
		if (newcheckNum != oldcheckNum) setOperatePool(oldNodes);
	}
	function checkAllTreeNode(checked) {
		var oldNodes = clone(zTree1.getNodes());
		var oldcheckNum = zTree1.getCheckedNodes(checked).length;
		zTree1.checkAllNodes(checked);
		var newcheckNum = zTree1.getCheckedNodes(checked).length;
		if (newcheckNum != oldcheckNum) setOperatePool(oldNodes);
	}

	function getNodeByParam() {
		var key = $("#searchKey").get(0).value;
		if (key.length > 0) {
			var treeNode = zTree1.getNodeByParam("name", key);
			if (treeNode) {
				alert("鎵惧埌鑺傜偣淇℃伅: \ntId=" + treeNode.tId + ", name=" + treeNode.name + ", level=" + treeNode.level);
			} else {
				alert("娌℃湁鎵惧埌鍖归厤鐨勮妭鐐癸紝璇锋洿鎹㈡悳绱㈡潯浠�);
			}
		}
	}
	function getNodesByParamFuzzy() {
		var key = $("#searchKeyFuzzy").get(0).value;
		if (key.length > 0) {
			var treeNodes = zTree1.getNodesByParamFuzzy("name", key);
			if (treeNodes && treeNodes.length>0) {
				var msg = "鎵惧埌鑺傜偣淇℃伅: ";
				for (var i=0; i<treeNodes.length; i++) {
					msg += ("\n(" + (i+1) + ") tId=" + treeNodes[i].tId + ", name=" + treeNodes[i].name + ", level=" + treeNodes[i].level); 
				}
				alert(msg);
			} else {
				alert("娌℃湁鎵惧埌鍖归厤鐨勮妭鐐癸紝璇锋洿鎹㈡悳绱㈡潯浠�);
			}
		}
	}
	
	function getNodesByParam() {
		var key = $("#searchKey2").get(0).value;
		if (key.length == 0 || isNaN(key)) {
			alert('璇疯緭鍏ユ暟瀛楋紒')
			return; 
		}
		key = parseInt(key);
		var treeNodes = zTree1.getNodesByParam("level", key);
		if (treeNodes && treeNodes.length>0) {
			var msg = "鎵惧埌鑺傜偣淇℃伅: ";
			for (var i=0; i<treeNodes.length; i++) {
				msg += ("\n(" + (i+1) + ") tId=" + treeNodes[i].tId + ", name=" + treeNodes[i].name + ", level=" + treeNodes[i].level); 
			}
			alert(msg);
		} else {
			alert("娌℃湁鎵惧埌鍖归厤鐨勮妭鐐癸紝璇锋洿鎹㈡悳绱㈡潯浠�);
		}
	}

	function reloadTree(node) {
		zTree1 = $("#treeDemo").zTree(setting, node?node:clone(zNodes));
		$("#renameTxt").attr("value", "");
		$("#curNodePath").html("[Root]");
		getNodes();
		initCopy();
		refreshOperatePool();
	}	

	function getNodePath(treeNode) {
		if (!treeNode) return "[Root]";
		var p = "[" + treeNode.name + "]";
		var pNode = treeNode.parentNode;
		while (pNode != null) {
			p = "[" + pNode.name + "] -- " + p;
			pNode = pNode.parentNode;
		}
		p = "[Root] -- " + p;
		return p;
	}

	function initCopyEvent() {
		$("#jCopy").bind("dblclick", noSelection);
		$("#jCut").bind("dblclick", noSelection);
		$("#jPaste").bind("dblclick", noSelection);
		$("#jRollback").bind("dblclick", noSelection);
		$("#jRedo").bind("dblclick", noSelection);
	}
	function noSelection(event) {
		event.target.blur();
		window.getSelection ? window.getSelection().removeAllRanges() : document.selection.empty();
		return false;
	}
	function initCopy() {
		$("#jCopy").attr("class","disabled");
		$("#jCut").attr("class","disabled");
		$("#jPaste").attr("class","disabled");
	}
	function showCopy(treeNode) {
		var canPaste = true;
		if (!treeNode) canPaste = false; 
		if (canPaste) {
			$("#jCopy").attr("class","able");
			$("#jCut").attr("class","able");
		} else {
			$("#jCopy").attr("class","disabled");
			$("#jCut").attr("class","disabled");
		}
		
	}
	function showPaste(targetNode) {
		var canPaste = true;
		
		if (!clipboard.srcNode || targetNode == clipboard.srcNode) {
			canPaste = false;
		} else if (clipboard.type) {
			if (targetNode == clipboard.srcNode.parentNode && clipboard.type=="cut") {
				canPaste = false;
			} else if (targetNode) {
				var tmpParent = targetNode.parentNode;
				while (tmpParent && tmpParent != clipboard.srcNode) {
					tmpParent = tmpParent.parentNode;
				}
				if (tmpParent) {
					canPaste = false;
				}
			}
		}
		 
		if (canPaste) {
			$("#jPaste").attr("class","able");
		} else {
			$("#jPaste").attr("class","disabled");
		}
	}
	var clipboard = {};
	function zCopy(type) {
		var treeNode = zTree1.getSelectedNode();
		if ($("#jCopy").attr("class") == "disabled" || !treeNode) {
			alert("璇峰厛閫夋嫨闇�" + (type=="copy"?"澶嶅埗":"鍓垏") + "鑺傜偣..");
		} else if (treeNode) {
			clipboard.type = type;
			clipboard.srcNode = treeNode;
			$("#jClip").text("......[" + treeNode.name + "] 琚� + (type=="copy"?"澶嶅埗":"鍓垏"));
		}
	}
	function zPaste() {
		var treeNode = zTree1.getSelectedNode();
		if (!clipboard.srcNode) {
			alert("璇峰厛 澶嶅埗 鎴�鍓垏 鑺傜偣..");
		} else if ($("#jPaste").attr("class") == "disabled") {
			alert("鏃犳硶绮樿创..");
		} else {
			if (clipboard.type=="copy") {
				setOperatePool();
				var cSrcNode = clone(clipboard.srcNode);
				zTree1.addNodes(treeNode, cSrcNode, false);
				zTree1.selectNode(cSrcNode);
			} else if (clipboard.type=="cut") {
				setOperatePool();
				zTree1.removeNode(clipboard.srcNode);
				zTree1.addNodes(treeNode, clipboard.srcNode, false);
				zTree1.selectNode(clipboard.srcNode);
				showCopy(clipboard.srcNode);
				clipboard.type==null;
				clipboard.srcNode = null;
				showPaste(clipboard.srcNode);
				$("#jClip").text("");
			}
		}
	}
	var opreatePool = [];
	var lastNode = null;
	var poolCursor = -1;
	var poolMax = 20;
	function setOperatePool(nodes) {
		
		var n = nodes ? nodes : clone(zTree1.getNodes());
		opreatePool.splice(poolCursor+1, (opreatePool.length-poolCursor-1), n);
		if (opreatePool.length>poolMax) {
			opreatePool.splice(0,1);
		}
		poolCursor = opreatePool.length-1;
		refreshOperatePool();
		lastNode = null;
	}
	function operateRollback() {		
		if (poolCursor>=0) {
			if (!lastNode) {
				lastNode = zTree1.getNodes();
			}
			var n = clone(opreatePool[poolCursor]);
			reloadTree(n);
			poolCursor--;
		}
		refreshOperatePool();
	}
	function operateRedo() {
		if (poolCursor<(opreatePool.length-2)) {
			poolCursor++;
			var n = clone(opreatePool[poolCursor+1]);
			reloadTree(n);
		} else if (lastNode) {
			poolCursor++;
			reloadTree(lastNode);
			lastNode = null;
		}
		refreshOperatePool();
	}
	function refreshOperatePool() {
		if (poolCursor>=0) {
			$("#jRollback").attr("class","able");
		} else {
			$("#jRollback").attr("class","disabled");
		}
		if (poolCursor<(opreatePool.length-1)) {
			$("#jRedo").attr("class","able");
		} else {
			$("#jRedo").attr("class","disabled");
		}
		$("#jOperatePool").html("鎿嶄綔璁板綍: " + opreatePool.length + ", 娓告爣浣嶇疆: " + (poolCursor+1));
	}
	
  //-->
  </SCRIPT>
 </HEAD>

<BODY>
<center class="headTitle">Javascript 鎿嶄綔婕旂ず</center>
<TABLE border=0 width="700" class="tb1">
	<TR>
		<TD width=340px align=center valign=top>
		<div class="zTreeDemoBackground">
			<ul id="treeDemo" class="tree"></ul>
		</div>		
		</TD>
		<TD width=360px align=left valign=top>
		<div class="demoContent">
			<li class="title focus">
				<button class="ico star" onfocus="this.blur();"></button>鑾峰彇鏁版嵁
				<ul class="remark">1銆佹�鑺傜偣鏁帮細<span id="allNum"></span>; 鎬籆heck鑺傜偣鏁帮細<span id="allCheckNum"></span></ul>
				<ul class="remark" style="white-space: normal;">2銆佸綋鍓嶉�涓妭鐐�/ul>
				<ul class="event"><li><span id="curNodePath"></span></li></ul>
			</li>
			<li class="title focus">
				<button class="ico star" onfocus="this.blur();"></button>鎿嶄綔鎸囩ず
				<ul class="operate">
					[<a id="jCopy" class="disabled" onclick="zCopy('copy'); return false;">澶嶅埗</a>] [<a id="jCut" class="disabled" onclick="zCopy('cut'); return false;">鍓垏</a>] [<a id="jPaste" class="disabled" onclick="zPaste(); return false;">绮樿创</a>]
					<span id="jClip" class="info"></span>
				</ul>
				<ul class="operate">
					[<a id="jRollback" class="disabled" onclick="operateRollback(); return false;">鎾ら攢</a>] [<a id="jRedo" class="disabled" onclick="operateRedo(); return false;">閲嶅仛</a>]
					&nbsp;&nbsp;&nbsp;&nbsp;<span id="jOperatePool" class="info"></span>
				</ul>
				<ul class="operate">
					淇敼鑺傜偣鍚嶇О: <input type="text" value="" id="renameTxt" onchange="renameTreeNode(this);"></input></button>
				</ul>
				<ul class="operate">
					澧炲姞鐖惰妭鐐� <button class="ico addNode" onfocus="this.blur();" title="澧炲姞鐖惰妭鐐� onclick="addNode('p');"></button>
					澧炲姞鍙跺瓙鑺傜偣: <button class="ico addNode" onfocus="this.blur();" title="澧炲姞鍙跺瓙鑺傜偣" onclick="addNode();"></button>
					鍒犻櫎鑺傜偣: <button class="ico removeNode" onfocus="this.blur();" title="鍒犻櫎鑺傜偣" onclick="removeTreeNode();"></button>
				</ul>
				<ul class="operate">
					淇敼閫変腑鑺傜偣Check鐘舵�锛�button class="ico checkNode" onfocus="this.blur();" title="Check鑺傜偣" onclick="checkTreeNode(true);"></button>
					<button class="ico unCheckNode" onfocus="this.blur();" title="unCheck鑺傜偣" onclick="checkTreeNode(false);"></button>
					<br/>鐖跺瓙鍏宠仈锛�INPUT TYPE="radio" id="connTrue" name="connRadio" onfocus="this.blur();">true;&nbsp;
					<INPUT TYPE="radio" id="connFalse" name="connRadio" checked onfocus="this.blur();">false
				</ul>
				<ul class="operate">
					淇敼鍏ㄩ儴鑺傜偣Check鐘舵�锛�button class="ico checkNode" onfocus="this.blur();" title="Check鍏ㄩ儴鑺傜偣" onclick="checkAllTreeNode(true);"></button>
					<button class="ico unCheckNode" onfocus="this.blur();" title="unCheck鍏ㄩ儴鑺傜偣" onclick="checkAllTreeNode(false);"></button>
				</ul>
				<ul class="operate">
					绉诲姩閫変腑鑺傜偣: 
					<button class="ico up" onfocus="this.blur();" title="鍚岀骇鍚戜笂绉诲姩" onclick="moveTreeNode('up');"></button>
					<button class="ico down" onfocus="this.blur();" title="鍚岀骇鍚戜笅绉诲姩" onclick="moveTreeNode('down');"></button>
					<button class="ico left" onfocus="this.blur();" title="鎴愪负鐖惰妭鐐瑰悓绾ц妭鐐� onclick="moveTreeNode('left');"></button>
					<button class="ico right" onfocus="this.blur();" title="鎴愪负鍓嶄竴涓妭鐐圭殑瀛愯妭鐐� onclick="moveTreeNode('right');"></button>
				</ul>
				<ul class="operate">
					閫変腑鑺傜偣:&nbsp;灞曞紑<button class="ico expandNode" onfocus="this.blur();" title="灞曞紑閫変腑鑺傜偣" onclick="expandNode(true);"></button>
					鎶樺彔<button class="ico collapseNode" onfocus="this.blur();" title="鎶樺彔閫変腑鑺傜偣" onclick="expandNode(false);"></button>
					&nbsp;<input type="checkbox" id="sonChk" /> 鏄惁鍖呭惈瀛愯妭鐐�
				</ul>
				<ul class="operate">
					鍏ㄩ儴鑺傜偣:&nbsp;灞曞紑<button class="ico expandNode" onfocus="this.blur();" title="鍏ㄩ儴灞曞紑" onclick="expandAll(true);"></button>
					鎶樺彔<button class="ico collapseNode" onfocus="this.blur();" title="鍏ㄩ儴鎶樺彔" onclick="expandAll(false);"></button> 
				</ul>
				<ul class="operate">
					鍚嶇О鍖归厤鎼滅储鍗曚釜鑺傜偣: <input type="text" value="鎵嬫満" id="searchKey"></input>
					<button class="ico searchNode" onfocus="this.blur();" title="鎼滅储" onclick="getNodeByParam();"></button>
					<br />getNodeByParam 鏂规硶婕旂ず锛堝畬鍏ㄥ尮閰嶏級
				</ul>
				<ul class="operate">
					鍚嶇О妯＄硦鎼滅储鍗曚釜鑺傜偣: <input type="text" value="鐢� id="searchKeyFuzzy"></input>
					<button class="ico searchNode" onfocus="this.blur();" title="鎼滅储" onclick="getNodesByParamFuzzy();"></button>
					<br />getNodesByParamFuzzy 鏂规硶婕旂ず锛堟ā绯婂尮閰嶏級
				</ul>
				<ul class="operate">
					level鎼滅储鑺傜偣闆嗗悎: <input type="text" value="0" id="searchKey2"></input>
					<button class="ico searchNode" onfocus="this.blur();" title="鎼滅储" onclick="getNodesByParam();"></button>
					<br />getNodesByParam 鏂规硶婕旂ず锛堝畬鍏ㄥ尮閰嶏級
				</ul>
			</li>
			
		</div>	
		</TD>
	</TR>
</TABLE>
</BODY>
</HTML>
